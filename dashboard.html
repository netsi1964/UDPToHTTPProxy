<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Flight monitor</title>
  <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    #map-canvas {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map-canvas"></div>
  <div class="container fluid">
    <div class="row">
      <h1>Flight monitor</h1>
    </div>
  </div>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="http://maps.google.com/maps/api/js"></script>
  <script>
    var PLANE_TRANSPARENCY = .75,
      MAX_TRACE = 4,
      DRAW_FLIGHT_PATHS = true,
      MAP_AUTO_CENTER = false,
      PAUSE = false;

    var flightPaths = {},
      mapsFlightPath,
      $pos = $(".pos"),
      f35,
      marker,
      animation,
      currentSimulator;

    var planes = {
      "default": "f-35",
      "tornado": {
        path: "M23.93 56.94V57c0-.18-.03-.36-.04-.54-.14 0-.24-.1-.24-.23v-1.3c-.12 0-.12-.38 0-.38v-.3c0-.08.04-.14.1-.2l-.06-1.24-.18-3.24h-.23c-.86.02-1.93.15-2.37 0h-.16l-.1-.27-.1.16c-.22-1.08-.4-2.22-.52-3.4-.07.22-.04.38-.02.55l.44 3.35-3.8 1.26v.02l-4.6 1.52c-.07-1.16-.1-2.24-.05-3.3l2.2-3.68 5.37-7.45v-1.27l-.06-2.8-.07-.04L0 39.23c.5-4.04 1.22-5.24 1.55-5.4l14.54-6.7.15-.23.08.17-.08-.16 2.3-3.73c-.02 0-.04-.22-.04-1V21.1c-.2-.07-.22-1.22 0-1.27l-.02-1.76.18-1h2.28l.03 5.1h.2v-5.68-.64 6.3-6.3c-.06-.18-.02-.14-.02-1.14 0-.2 0-.47.02-.76v-.1c.06-1.37.2-3.42.36-5.07l.02-.13c0-.06.03-.1.04-.16 0-.22.02-.33.05-.53v-.1c.02-.03.02-.06.03-.1 0-.04.02-.07.03-.1l.02-.03V7.6l-.02.08.07-.55.2-1.53c.2-1.45 1.34-3.97 1.85-5.36l-.03.1.03-.1V.3l.06-.15.02-.08V0h.02v.07l.04.08.07.14V.23c0 .04.02.07.03.1l-.03-.1c.5 1.4 1.64 3.9 1.85 5.36l.2 1.53.07.55-.02-.07v.08c.02.02.04.05.04.1v.1l.02.1.06.53c0 .06.03.1.03.17l.04.12c.15 1.64.3 3.7.36 5.07v.1l.02.75c0 1 .04.96-.02 1.13v6.3-6.3 6.3h.2l.03-5.1 2.28.02.2 1-.02 1.75c.2.05.18 1.2 0 1.27l-.02 1.08c0 .77-.03 1-.03 1l2.3 3.73c-.05.06-.07.1-.1.17l.1-.16.15.23 14.54 6.72c.33.15 1.05 1.35 1.55 5.4L28.4 34.17l-.07.04c-.03.9-.04 1.83-.06 2.8v1.3l5.37 7.44 2.2 3.67c.07 1.07.03 2.15-.05 3.3l-4.6-1.52v.02l-3.8-1.27.44-3.34c.02-.16.05-.32-.02-.53-.13 1.17-.3 2.3-.53 3.4l-.1-.18-.1.26h-.16c-.44.15-1.5.02-2.36 0h-.23l-.18 3.25c0 .4-.03.8-.05 1.26.05.05.1.1.1.18v.3c.1 0 .1.4 0 .4v1.3c0 .12-.1.22-.24.22 0 .18-.03.36-.04.54v-.07z",
        fillColor: "#d0d0d0",
        fillOpacity: 0.8,
        scale: 1,
        strokeColor: "black",
        strokeWeight: 1,
        anchorPoint: new google.maps.Point(1500, -1300),
        rotation: 45
      },
      "f-35": {
        path: "M21.593,52.299l-2.547,0l-1.129,-2.204c-0.655,2.489 -0.979,4.894 -1.284,8.01l-0.17,0l-9.527,-2.377l0,-3.123l5.534,-3.782l1.053,-2.428l-12.909,-3.282l0,-5.646c3.924,-2.659 7.849,-5.323 11.779,-8.036l1.39,-2.72l0.376,-8.863l0.735,-1.558l1.569,1.558l0.673,-1.558l1.505,-11.869c0.462,-1.361 1.033,-2.554 1.66,-3.689c0,0 1.235,2.328 1.698,3.689l1.504,11.869l0.673,1.558l1.569,-1.558l0.736,1.558l0.375,8.863l1.39,2.72c3.93,2.713 7.855,5.377 11.78,8.036l0,5.646l-12.91,3.282l1.053,2.428l5.534,3.782l0,3.123l-9.527,2.377l-0.17,0c-0.305,-3.116 -0.629,-5.521 -1.283,-8.01l-1.13,2.204Z",
        fillColor: "#d0d0d0",
        fillOpacity: 0.8,
        scale: 1,
        strokeColor: "black",
        strokeWeight: 1,
        origin: new google.maps.Point(25, 25),
        rotation: 45
      }
    }

    function scalePlanes() {
      var scale = map.getZoom() / 10;
      for (plane in flightPaths) {
        flightPaths[plane].marker.getIcon().scale = scale;
      }
    }

    function getPlane(planeID, color) {
      planeID = planeID.toLowerCase();
      var plane = (typeof planes[planeID] !== "undefined") ? planes[planeID] : planes[planes.default];
      plane.fillColor = color;
      return plane;
    }

    /**
     * Converts color data from simulator to valid CSS color
     * @param  {string} simulatorColor Example "100.100.100" for a grey color
     * @return {string}                A valid CSS color, f.eks. rgb(100,100,100)
     */
    function parseColor(simulatorColor) {
      return "rgba(" + simulatorColor.replace(/\./g, ",") + "," + PLANE_TRANSPARENCY + ")";
    }

    function getFlightPosition(sURL, sPort) {
      if (!PAUSE) {


        sURL = (typeof sURL !== "undefined") ? sURL : "http://localhost";
        sPort = (typeof sPort !== "undefined") ? sPort : "8080";
        $.getJSON(sURL + ":" + sPort, function(planes) {
          /*  Example data:
                    [
                      {
                      "id":"1",
                      "country":"Denmark",
                      "city":"Aarhus",
                      "type":"F-35",
                      "sim":"1",
                      "lat":"56.297872",
                      "long":"10.502243",
                      "alt":"100",
                      "color":"100.50.140"},{"id":"2",
                      "country":"Denmark",
                      "city":"Aarhus",
                      "type":"F-35",
                      "sim":"1",
                      "lat":"56.383236",
                      "long":"10.341481",
                      "alt":"100",
                      "color":"100.150.140"
                      }
                      ]
                    */
          if (planes.length > 0) {

            for (var plane = 0; plane < planes.length; plane++) {
              currentSimulator = planes[plane];


              if (currentSimulator.id === "") {
                console.log("Seems that data is not valid", currentSimulator);
                break;
              };

              currentSimulator.color = parseColor(currentSimulator.color);

              /**
               * flightPath is an Array which contains a number of current and previous positions of a plane
               */
              var flightPath = (typeof flightPaths[currentSimulator.id] === "undefined") ? flightPaths[currentSimulator.id] = [] : flightPaths[currentSimulator.id];

              var rawLatLng = {
                lat: parseFloat(currentSimulator.lat),
                lng: parseFloat(currentSimulator.long)
              };
              var myLatLng = new google.maps.LatLng(rawLatLng);

              // We only want to store a number (MAX_TRACE) of previous positions
              if (flightPath.length > MAX_TRACE) {
                flightPath.shift();
              }
              flightPath.push(rawLatLng);



              mapsFlightPath = new google.maps.Polyline({
                path: flightPath,
                geodesic: true,
                strokeColor: currentSimulator.color,
                strokeOpacity: 1,
                strokeWeight: 1
              });

              if (DRAW_FLIGHT_PATHS) {
                mapsFlightPath.setMap(map);
              }

              if (typeof flightPath.marker !== "undefined") {
                // flightPath.marker.setMap(null);
                flightPath.marker.setPosition(myLatLng);
                flightPath.marker.setLabel(currentSimulator.id.toString());
                animation = null;
              } else {
                // First time running
                animation = google.maps.Animation.DROP;
                map.panTo(myLatLng);
                flightPath.marker = new google.maps.Marker({
                  position: myLatLng,
                  icon: getPlane(currentSimulator.type, currentSimulator.color),
                  map: map,
                  animation: animation
                });
              };
              flightPath.marker.setMap(map);

              try {
                var point1 = (flightPath.lastPosition) ? flightPath.lastPosition : initPosition;
                var point2 = flightPath.lastPosition = myLatLng;
                var heading = google.maps.geometry.spherical.computeHeading(point1, point2);
                flightPath.marker.getIcon().rotation = heading;
              } catch (e) {
                console.log("Could not set heading: " + e.message);
              } finally {

              }



              // marker.setPosition(map.getCenter());
              if (MAP_AUTO_CENTER) {
                map.panTo(myLatLng, animate = true);
              }
            }
          }
        });
      }
      setTimeout(getFlightPosition, 1000);
    }

    var lat = -34;
    var lng = 150;
    var map, initPosition;

    function initializeMap() {
      initPosition = new google.maps.LatLng(lat, lng);
      var mapOptions = {
        zoom: 10,
        center: initPosition,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);

      getFlightPosition();

      google.maps.event.addDomListener(map, "zoom_changed", function() {
        scalePlanes();
      })



    }
    google.maps.event.addDomListener(window, 'load', initializeMap);
  </script>
</body>

</html>
